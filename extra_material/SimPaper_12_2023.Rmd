---
title: "Treatment-control comparisons in platform trials with non-concurrent controls - preliminary simulations"
author: "Marta Bofill Roig, Pavla Krotka"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: yes
    toc_depth: 3
    toc_float: true
    number_sections: true
    code_folding: show 
    theme: flatly
---

```{r setup, include = FALSE}
library(knitr)
opts_chunk$set(collapse = TRUE,
               comment = "#>",
               warning = FALSE,
               message = FALSE,
               echo = FALSE,
               fig.align = "center",
               out.width = "100%")
```

```{r, include=FALSE}
library(gifski)
library(plotly)
library(ggpubr)
library(scales)
library(kableExtra)
library(latex2exp)
library(tidyverse)

#devtools::install_github("pavlakrotka/NCC@v1.0", build = TRUE, force=T)
library(NCC)
set.seed(717)
```


```{r}
# Load in all files from "results"

csv_names <- list.files("results/", pattern="*.csv")

for (i in 1:length(csv_names)){
  assign(str_extract(csv_names[i], "^([^\\.])+"), read_csv(paste0("results/", csv_names[i])) %>%
           mutate(model = as.factor(case_when(model=="fixmodel" ~ "Regression model",
                                              model=="MAPpriorNew" ~ "MAP Prior",
                                              model=="poolmodel" ~ "Pooled approach",
                                              model=="sepmodel" ~ "Separate approach",
                                              model=="timemachine" ~ "Time machine")),
                  trend = case_when(trend=="linear" ~ "Linear time trend",
                                    trend=="stepwise_2" ~ "Stepwise time trend",
                                    trend=="inv_u" ~ "Inverted-U trend")))
}

my_palette = c("#ED0000FF",
               "#42B540FF",
               "#00468BFF",
               "#925E9FFF",
               "#EEAD0E",
               "#0099B4FF",
               "#FDAF91FF",
               "#ADB6B6FF",
               "#1B1919FF")

#show_col(my_palette)

# Prediction interval for T1E
p <- 0.025
alpha <- 0.05
nsim <- 1000
sd <- sqrt(p*(1-p)/nsim)
z.alpha <- qnorm(1-alpha/2,0,1)
pred_int <- c(p-z.alpha*sd,p+z.alpha*sd)
```




# Introduction

This simulation study aims to compare frequentist and Bayesian approaches to perform treatment-control comparisons in platform trials using non-concurrent controls (NCC). In this simulation, we restricted the attention to trials with continuous endpoints.


# Methods

We consider the following approaches:

- **Frequentist regression model** that takes into account all data until the arm under study left the trial and adjusts for periods using a stepwise function. Note: this model is the extension of the one presented in the paper ([Bofill Roig et al.](https://bmcmedresmethodol.biomedcentral.com/articles/10.1186/s12874-022-01683-w)), but with more than two arms.

- The **Bayesian Time Machine** ([Saville et al.](https://journals.sagepub.com/doi/full/10.1177/17407745221112013)), which uses a second-order Bayesian normal dynamic linear model (NDLM), takes into account all data until the investigated arm left the trial and includes covariate adjustment for time (separating the trial into buckets of pre-defined size) using a hierarchical model that smooths the control response rate over time.

- The **MAP prior** approach ([Schmidli et al.](https://onlinelibrary.wiley.com/doi/full/10.1111/biom.12242)), where non-concurrent control data is used to obtain the MAP prior distribution for the control response in the concurrent period.

For comparative purposes, we also analyse the data using the **separate approach** (CC data only), as well as **naive pooling** of CC and NCC data.

# Data generation

## Trial design

We simulated platform trials evaluating the efficacy of $K$ treatment arms compared to a shared control. Arm $k$ ($k>1$) enters after $d_k$ patients have been recruited to the trial and $d_1=0$. Patients are allocated to treatment arms and control following 1:...:1 allocation. The duration of the trial is split into $S$ periods, which are defined as time intervals bounded by any treatment either entering or leaving the trial.

```{r, out.width="90%"}
include_graphics("figures/trial_general_3.png")
```

## Patient response

The continuous response $y_j$ for patient $j$ was generated according to:

$$E(y_j) = \eta_0 + \sum_{k=1}^K \cdot I(k_j=k) + f(j)$$
where $\eta_0$ and $\theta_k$ are the response in the control arm and the effect of treatment $k$.

The function $f(j)$ denotes the time trend, whose strength is indicated by $\lambda_{k_j}$ and which can have two patterns:

- **Linear time trend**: $f(j) = \lambda_{k_j} \cdot \frac{j-1}{N-1}$, where $N$ is the total sample size in the trial


- **Stepwise time trend**: $f(j) = \lambda_{k_j} \cdot (c_j - 1)$, where $c_j$ is an indicator of how many treatment arms have already entered the ongoing trial, when patient $j$ was enrolled


- **Inverted-U time trend**: $$f(j) = \begin{cases}
\lambda \cdot \frac{j-1}{N-1}  & \text{for } j \leq N_p \\
-\lambda \cdot \frac{j-N_p}{N-1} + \lambda \cdot \frac{N_p-1}{N-1} & \text{for } j > N_p
\end{cases}$$

where $N_p$ indicates the point at which the trend switches direction


# Considered designs

We consider three designs of platform trials with $K$ treatment arms that enter the trial in a staggered way. Each design corresponds to an objective:

- In **Design I**, we explore the effect of the overlap between arms in trials with $K=3$ experimental arms, in settings with equal time trends and different time trends.

- In **Design II**, we investigate the impact of different entry times in trials with $K=4$ arms. For this, we vary the entry time of arm $3$ and consider equal time trends only.

- In **Design III**, we explore the operating characteristics of more realistic platform trials. We consider $K=10$ arms, and random time trends.

The considered trial designs are illustrated bellow.

In all three designs, we assume equal sample sizes of 250 in all treatment arms and 1:1:...:1 allocation ratio in each period, and consider different scenarios varying the overlaps between arms indicated by $\mathbf{d} = (d_1,...,d_K)$. Furthermore, we consider linear, stepwise and inverted-U time trends, which are either equal across all arms, or different in arm 1 or arms 1 and 2 (in this case, only arm 3 is evaluated). For the Bayesian Time Machine, we used bucket sizes of 25 in all designs. Moreover, we assumed effect sizes of $\theta_{i} = 0.25, i=1,...,K$ for the treatment-control comparisons under the alternative hypothesis. The chosen sample and effect sizes lead to 80\% power for the treatment-control comparison using a separate analysis (one-sided t-test at 2.5\% significance level).


## Considered parameters for the Time Machine

In the remainder of this report, the following parameters were used for the Time machine:

- `prec_theta`: 0.001
- `prec_eta`: 0.001
- `prec_a`: 0.001
- `prec_b`: 0.001
- `bucket_size`: 25

For the parameters `tau_a` and `tau_b` we consider the following options based on the expected and maximal jump in the control response between periods:


```{r}
from_jump_size_to_tau_a_b <- function(e_jump_size = 0.01, max_jump_size = 0.1){
  
  fun_to_solve <- function(tau_b, max_jump_size, e_jump_size){
    pgamma(1 / max_jump_size ^ 2, 1 / (e_jump_size ^ 2) * tau_b, tau_b) - 0.01
  }
  
  tau_b <- uniroot(fun_to_solve,
                   c(1e-12, 1e12),
                   max_jump_size = max_jump_size,
                   e_jump_size = e_jump_size)$root
  
  tau_a <- 1 / e_jump_size ^ 2 * tau_b
  
  c(tau_a = tau_a,
    tau_b = tau_b)
}
```

**Assuming stepwise time trend with $\lambda=0.15$ and $d=250$**

```{r}
kable(data.frame("Assumption" = c("Reasonable jump", "Small jump", "Large jump"),
                 "Expected jump" = c(0.01, 0.001, 10),
                 "Maximal jump" = c(0.15, 0.015, 15),
                 "tau_a" = c(from_jump_size_to_tau_a_b(e_jump_size = 0.01, max_jump_size = 0.15)[1],
                             from_jump_size_to_tau_a_b(e_jump_size = 0.001, max_jump_size = 0.015)[1],
                             from_jump_size_to_tau_a_b(e_jump_size = 10, max_jump_size = 15)[1]),
                 "tau_b" = c(from_jump_size_to_tau_a_b(e_jump_size = 0.01, max_jump_size = 0.15)[2],
                             from_jump_size_to_tau_a_b(e_jump_size = 0.001, max_jump_size = 0.015)[2],
                             from_jump_size_to_tau_a_b(e_jump_size = 10, max_jump_size = 15)[2]),
                 check.names = F),
      escape = F, booktabs = F, align = "c") %>%
  kable_classic(full_width = F) %>%
  kable_styling(bootstrap_options = "bordered") %>%
  row_spec(0, bold = T) %>%
  column_spec(1, bold = T)
```

In plots comparing different methods to incorporate NCC, we use the assumption of a reasonable jump of the time trend. In plots showing the calibration of the Time Machine model, we present a comparison of the three assumed jump sizes (only for Design I).

```{r, eval=FALSE}
# **(B) Assuming linear time trend with $\lambda=0.15$ and $d=250$**

kable(data.frame("Assumption" = c("Reasonable jump", "Small jump", "Large jump"),
                 "Expected jump" = c(0.01/100, 0.001/100, 10/100),
                 "Maximal jump" = c(0.15/100, 0.015/100, 15/100),
                 "tau_a" = c(from_jump_size_to_tau_a_b(e_jump_size = 0.01/100, max_jump_size = 0.15/100)[1],
                             from_jump_size_to_tau_a_b(e_jump_size = 0.001/100, max_jump_size = 0.015/100)[1],
                             from_jump_size_to_tau_a_b(e_jump_size = 10/100, max_jump_size = 15/100)[1]),
                 "tau_b" = c(from_jump_size_to_tau_a_b(e_jump_size = 0.01/100, max_jump_size = 0.15/100)[2],
                             from_jump_size_to_tau_a_b(e_jump_size = 0.001/100, max_jump_size = 0.015/100)[2],
                             from_jump_size_to_tau_a_b(e_jump_size = 10/100, max_jump_size = 15/100)[2]),
                 check.names = F),
      escape = F, booktabs = F, align = "c") %>%
  kable_classic(full_width = F) %>%
  kable_styling(bootstrap_options = "bordered") %>%
  row_spec(0, bold = T) %>%
  column_spec(1, bold = T)
```


## Considered parameters for the MAP Prior

In the remainder of this report, the following parameters were used for the MAPPrior function when compating this approach to other methods:

- `opt`: 2
- `n_samples`: 1000
- `n_chains`: 4
- `n_iter`: 4000
- `n_adapt`: 1000
- `robustify`: TRUE
- `weight`: 0.1
- `prior_prec_eta`: 1
- `prior_prec_tau`: 0.002

In plots showing the calibration of the MAP approach, we consider the following options for `prior_prec_eta` and `prior_prec_tau`:

- `prior_prec_eta` $\in \{ 0.001, 1 \}$
- `prior_prec_tau` $\in \{ 2, 0.2, 0.002 \}$

while the other parameters remain unchanged.



# Results

## Design I

- 3 treatment arms
- Equal and different time trends
- Equidistant entry times
- Vary entry times $d_i$

In the first design, we examine a platform trial with 3 treatment arms, where treatment arm $i$ enters after every $d_i = d \cdot (i-1)$ patients have joined the trial. We consider 5 options for $d = (0, 125, 250, 375, 500)$, resulting in platform trials with different overlaps between arms, as illustrated below. We consider time trend that are equal across all arms, or that differ either in arm 1, or in arms 1 and 2. In cases with different time trends, only treatment arm 3 is evaluated.

- Considered time trends:

```{r}
kable(data.frame("Trt 1" = c("$\\lambda$", "$\\lambda$","$\\lambda$"),
                 "Trt 2" = c("$\\lambda$", 0.1, "$\\lambda$"),
                 "Trt 3 = Control" = c("$\\lambda$", 0.1, 0.1),
                 check.names = F),
      escape = F, booktabs = F, align = "c") %>%
  kable_classic(full_width = F) %>%
  kable_styling(bootstrap_options = "bordered") %>%
  row_spec(0, bold = T)
```


### Overview {.tabset}

#### d = 0 {.unnumbered}

```{r, fig.height=9}
d <- seq(0, 500, length.out=5)[1]

trial_data <- datasim_cont(num_arms = 3, 
                           n_arm = 250, 
                           d = d*(0:2),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 3),
                           lambda = rep(0.15, 4),
                           trend = "stepwise_2", full = T)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1500)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d = ", d))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1500), ylim = c(0, 0.3)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d = ", d))

print(ggarrange(p1, p2, ncol = 1))
```


#### d = 125 {.unnumbered}

```{r, fig.height=9}
d <- seq(0, 500, length.out=5)[2]

trial_data <- datasim_cont(num_arms = 3, 
                           n_arm = 250, 
                           d = d*(0:2),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 3),
                           lambda = rep(0.15, 4),
                           trend = "stepwise_2", full = T)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1500)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d = ", d))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1500), ylim = c(0, 0.3)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d = ", d))

print(ggarrange(p1, p2, ncol = 1))
```

#### d = 250 {.unnumbered}

```{r, fig.height=9}
d <- seq(0, 500, length.out=5)[3]

trial_data <- datasim_cont(num_arms = 3, 
                           n_arm = 250, 
                           d = d*(0:2),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 3),
                           lambda = rep(0.15, 4),
                           trend = "stepwise_2", full = T)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1500)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d = ", d))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1500), ylim = c(0, 0.3)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d = ", d))

print(ggarrange(p1, p2, ncol = 1))
```

#### d = 375 {.unnumbered}

```{r, fig.height=9}
d <- seq(0, 500, length.out=5)[4]

trial_data <- datasim_cont(num_arms = 3, 
                           n_arm = 250, 
                           d = d*(0:2),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 3),
                           lambda = rep(0.15, 4),
                           trend = "stepwise_2", full = T)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1500)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d = ", d))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1500), ylim = c(0, 0.3)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d = ", d))

print(ggarrange(p1, p2, ncol = 1))
```

#### d = 500 {.unnumbered}

```{r, fig.height=9}
d <- seq(0, 500, length.out=5)[5]

trial_data <- datasim_cont(num_arms = 3, 
                           n_arm = 250, 
                           d = d*(0:2),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 3),
                           lambda = rep(0.15, 4),
                           trend = "stepwise_2", full = T)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1500)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d = ", d))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1500), ylim = c(0, 0.3)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d = ", d))

print(ggarrange(p1, p2, ncol = 1))
```







### No time trend

- $\lambda_k = 0$, $\forall k$

#### Type I error

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_alpha) %>% 
              filter(lambda1==0), 
            aes(color=model, linetype=as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Type I error", color="Analysis approach, arm under study", linetype="") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_eq_alpha$d2), labels = unique(results_i_eq_alpha$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
```

#### Power

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_pow) %>% 
              filter(lambda1==0), 
            aes(color=model, linetype=as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Power", color="Analysis approach, arm under study", linetype="") +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_eq_pow$d2), labels = unique(results_i_eq_pow$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
```


### Equal time trend

#### Type I error w.r.t. d

- $\lambda_k = 0.15$, $\forall k$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_alpha) %>%
              filter(lambda1==0.15), 
            aes(color=model, linetype=as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Type I error", color="Analysis approach, arm under study", linetype="") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_eq_alpha$d2), labels = unique(results_i_eq_alpha$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_alpha_d.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```



#### Power w.r.t. d

- $\lambda_k = 0.15$, $\forall k$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_pow) %>% 
              filter(lambda1==0.15), aes(color=model, linetype = as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Power", color="Analysis approach, arm under study", linetype="") +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_eq_pow$d2), labels = unique(results_i_eq_pow$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_pow_d.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```



#### Type I error w.r.t. $\lambda$

- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_alpha) %>%
              filter(d2==250), 
            aes(color=model, linetype=as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(lambda0, reject_h0)) +
  geom_point(aes(lambda0, reject_h0)) +
  labs(x="lambda", y="Type I error", color="Analysis approach, arm under study", linetype="") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_eq_alpha$lambda0), labels = unique(results_i_eq_alpha$lambda0)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_alpha_lambda.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```



#### Power w.r.t. $\lambda$

- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_pow) %>% 
              filter(d2==250), aes(color=model, linetype = as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(lambda0, reject_h0)) +
  geom_point(aes(lambda0, reject_h0)) +
  labs(x="lambda", y="Power", color="Analysis approach, arm under study", linetype="") +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_eq_pow$lambda0), labels = unique(results_i_eq_pow$lambda0)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_pow_lambda.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```


### Time Machine calibration

#### Type I error w.r.t. d

- $\lambda_k = 0.15$, $\forall k$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_alpha_TM_step) %>%
              filter(lambda1==0.15), 
            aes(color=tau_case, linetype=as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Type I error", color="Assumed jump, arm under study", linetype="") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_eq_alpha_TM_step$d2), labels = unique(results_i_eq_alpha_TM_step$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_alpha_d.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```



#### Power w.r.t. d

- $\lambda_k = 0.15$, $\forall k$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_pow_TM_step) %>% 
              filter(lambda1==0.15), aes(color=tau_case, linetype = as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Power", color="Assumed jump, arm under study", linetype="") +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_eq_pow_TM_step$d2), labels = unique(results_i_eq_pow_TM_step$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_pow_d.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```



#### Type I error w.r.t. $\lambda$

- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_alpha_TM_step) %>%
              filter(d2==250), 
            aes(color=tau_case, linetype=as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(lambda0, reject_h0)) +
  geom_point(aes(lambda0, reject_h0)) +
  labs(x="lambda", y="Type I error", color="Assumed jump, arm under study", linetype="") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_eq_alpha_TM_step$lambda0), labels = unique(results_i_eq_alpha_TM_step$lambda0)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_alpha_lambda.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```



#### Power w.r.t. $\lambda$

- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_pow_TM_step) %>% 
              filter(d2==250), aes(color=tau_case, linetype = as.factor(study_arm))) +
  facet_grid(.~ trend) +
  geom_line(aes(lambda0, reject_h0)) +
  geom_point(aes(lambda0, reject_h0)) +
  labs(x="lambda", y="Power", color="Assumed jump, arm under study", linetype="") +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_eq_alpha_TM_step$lambda0), labels = unique(results_i_eq_alpha_TM_step$lambda0)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_pow_lambda.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```











### MAP Prior calibration

#### Type I error w.r.t. d

- $\lambda_k = 0.15$, $\forall k$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_alpha_MAP) %>%
              filter(lambda1==0.15), 
            aes(color=as.factor(prior_prec_tau), linetype=as.factor(prior_prec_eta))) +
  facet_grid(.~ trend) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Type I error", color="prior_prec_tau, prior_prec_eta", linetype="") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_eq_alpha_MAP$d2), labels = unique(results_i_eq_alpha_MAP$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_alpha_d.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```



#### Power w.r.t. d

- $\lambda_k = 0.15$, $\forall k$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_pow_MAP) %>% 
              filter(lambda1==0.15), 
            aes(color=as.factor(prior_prec_tau), linetype=as.factor(prior_prec_eta))) +
  facet_grid(.~ trend) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Power", color="prior_prec_tau, prior_prec_eta", linetype="") +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_eq_pow_MAP$d2), labels = unique(results_i_eq_pow_MAP$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_pow_d.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```



#### Type I error w.r.t. $\lambda$

- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_alpha_MAP) %>%
              filter(d2==250), 
            aes(color=as.factor(prior_prec_tau), linetype=as.factor(prior_prec_eta))) +
  facet_grid(.~ trend) +
  geom_line(aes(lambda0, reject_h0)) +
  geom_point(aes(lambda0, reject_h0)) +
  labs(x="lambda", y="Type I error", color="prior_prec_tau, prior_prec_eta", linetype="") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_eq_alpha_MAP$lambda0), labels = unique(results_i_eq_alpha_MAP$lambda0)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_alpha_lambda.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```



#### Power w.r.t. $\lambda$

- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_eq_pow_MAP) %>% 
              filter(d2==250), 
            aes(color=as.factor(prior_prec_tau), linetype=as.factor(prior_prec_eta))) +
  facet_grid(.~ trend) +
  geom_line(aes(lambda0, reject_h0)) +
  geom_point(aes(lambda0, reject_h0)) +
  labs(x="lambda", y="Power", color="prior_prec_tau, prior_prec_eta", linetype="") +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_eq_pow_MAP$lambda0), labels = unique(results_i_eq_pow_MAP$lambda0)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_eq_pow_lambda.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```




### Different time trend in arm 1

#### Type I error w.r.t. d

- $\lambda_0 = \lambda_2 = \lambda_3 = 0.1$
- $\lambda_1 = 0.25$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_diff1_alpha) %>% 
              filter(lambda1==0.25), 
            aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Type I error", color="Analysis approach, arm under study", linetype="") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_diff1_alpha$d2), labels = unique(results_i_diff1_alpha$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_diff1_alpha.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```

#### Power w.r.t. d

- $\lambda_0 = \lambda_2 = \lambda_3 = 0.1$
- $\lambda_1 = 0.25$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_diff1_pow) %>% 
              filter(lambda1==0.25), 
            aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Power", color="Analysis approach, arm under study", linetype = "") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_diff1_pow$d2), labels = unique(results_i_diff1_pow$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_diff1_pow.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```


#### Type I error w.r.t. $\lambda$

- $\lambda_0 = \lambda_2 = \lambda_3 = 0.1$
- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_diff1_alpha) %>% 
              filter(d2==250), 
            aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(lambda1, reject_h0)) +
  geom_point(aes(lambda1, reject_h0)) +
  labs(x="lambda_1", y="Type I error", color="Analysis approach, arm under study", linetype="") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_diff1_alpha$lambda1), labels = unique(results_i_diff1_alpha$lambda1)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_diff1_alpha.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```

#### Power w.r.t. $\lambda$

- $\lambda_0 = \lambda_2 = \lambda_3 = 0.1$
- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_diff1_pow) %>% 
              filter(d2==250), 
            aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(lambda1, reject_h0)) +
  geom_point(aes(lambda1, reject_h0)) +
  labs(x="lambda_1", y="Power", color="Analysis approach, arm under study", linetype = "") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_diff1_pow$lambda1), labels = unique(results_i_diff1_pow$lambda1)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/i_diff1_pow.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```


### Different time trends in arms 1 and 2

#### Type I error w.r.t. d

- $\lambda_0 = \lambda_3 = 0.1$
- $\lambda_1 = \lambda_2 = 0.25$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_diff12_alpha) %>% 
              filter(lambda1==0.25), 
            aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Type I error", color="Analysis approach, arm under study", linetype="") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_diff12_alpha$d2), labels = unique(results_i_diff12_alpha$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
```

#### Power w.r.t. d

- $\lambda_0 = \lambda_3 = 0.1$
- $\lambda_1 = \lambda_2 = 0.25$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_diff12_pow) %>% 
              filter(lambda1==0.25), 
            aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(d2, reject_h0)) +
  geom_point(aes(d2, reject_h0)) +
  labs(x="d", y="Power", color="Analysis approach, arm under study", linetype="") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_i_diff12_pow$d2), labels = unique(results_i_diff12_pow$d2)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
```




#### Type I error w.r.t. $\lambda$

- $\lambda_0 = \lambda_3 = 0.1$
- $\lambda_1 = \lambda_2$
- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_diff12_alpha) %>% 
              filter(d2==250), 
            aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(lambda1, reject_h0)) +
  geom_point(aes(lambda1, reject_h0)) +
  labs(x="lambda_1", y="Type I error", color="Analysis approach, arm under study", linetype="") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_diff12_alpha$lambda1), labels = unique(results_i_diff12_alpha$lambda1)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
```

#### Power w.r.t. $\lambda$

- $\lambda_0 = \lambda_3 = 0.1$
- $\lambda_1 = \lambda_2$
- $d = 250$

```{r, echo=FALSE, fig.height=8}
p <- ggplot(rbind(results_i_diff12_pow) %>% 
              filter(d2==250), 
            aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(lambda1, reject_h0)) +
  geom_point(aes(lambda1, reject_h0)) +
  labs(x="lambda_1", y="Power", color="Analysis approach, arm under study", linetype="") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  #scale_x_continuous(breaks = unique(results_i_diff12_pow$lambda1), labels = unique(results_i_diff12_pow$lambda1)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
```



## Desing II

- 4 treatment arms
- Equal time trends
- Non-equidistant entry times
- Vary entry time $d_3$ for arm 3

In the second design, we examine a platform trial with 4 treatment arms, where treatment arms 2 and 4 enter after every $d_2=300$ and $d_4=800$ patients have been recruited to the trial, respectively. In this case, there are 5 options for the timing of adding the third treatment arm $d_3 = (300, 425, 550, 675, 800)$, as illustrated below.


### Overview {.tabset}

#### d3 = 300 {.unnumbered}

```{r, fig.height=8}
d3 <- seq(300, 800, length.out=5)[1]

trial_data <- datasim_cont(num_arms = 4, 
                           n_arm = 250, 
                           d = c(0, 300, d3, 800),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 4),
                           lambda = rep(0.15, 5),
                           trend = "stepwise_2",
                           full = TRUE)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1600)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d3 = ", d3))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1600), ylim = c(0, 0.45)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d3 = ", d3))

print(ggarrange(p1, p2, ncol = 1))
```



#### d3 = 425 {.unnumbered}

```{r, fig.height=8}
d3 <- seq(300, 800, length.out=5)[2]

trial_data <- datasim_cont(num_arms = 4, 
                           n_arm = 250, 
                           d = c(0, 300, d3, 800),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 4),
                           lambda = rep(0.15, 5),
                           trend = "stepwise_2",
                           full = TRUE)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1600)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d3 = ", d3))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1600), ylim = c(0, 0.45)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d3 = ", d3))

print(ggarrange(p1, p2, ncol = 1))
```


#### d3 = 550 {.unnumbered}

```{r, fig.height=8}
d3 <- seq(300, 800, length.out=5)[3]

trial_data <- datasim_cont(num_arms = 4, 
                           n_arm = 250, 
                           d = c(0, 300, d3, 800),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 4),
                           lambda = rep(0.15, 5),
                           trend = "stepwise_2",
                           full = TRUE)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1600)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d3 = ", d3))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1600), ylim = c(0, 0.45)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d3 = ", d3))

print(ggarrange(p1, p2, ncol = 1))
```


#### d3 = 675 {.unnumbered}

```{r, fig.height=8}
d3 <- seq(300, 800, length.out=5)[4]

trial_data <- datasim_cont(num_arms = 4, 
                           n_arm = 250, 
                           d = c(0, 300, d3, 800),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 4),
                           lambda = rep(0.15, 5),
                           trend = "stepwise_2",
                           full = TRUE)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1600)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d3 = ", d3))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1600), ylim = c(0, 0.45)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d3 = ", d3))

print(ggarrange(p1, p2, ncol = 1))
```


#### d3 = 800 {.unnumbered}

```{r, fig.height=8}
d3 <- seq(300, 800, length.out=5)[5]

trial_data <- datasim_cont(num_arms = 4, 
                           n_arm = 250, 
                           d = c(0, 300, d3, 800),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0.25, 4),
                           lambda = rep(0.15, 5),
                           trend = "stepwise_2",
                           full = TRUE)$Data

p1 <- plot_trial(trial_data$treatment) +
  coord_cartesian(xlim = c(0, 1600)) +
  labs(title = "Trial progress over time",
       subtitle = paste0("d3 = ", d3))

p2 <- ggplot(trial_data %>%
               mutate(treatment = ifelse(treatment==0, 0, NA))) +
  geom_point(aes(x=c(1:nrow(trial_data)), y=means, color = as.factor(treatment)), size = 3) +
  coord_cartesian(xlim = c(0, 1600), ylim = c(0, 0.45)) +
  scale_color_discrete(na.translate = F) +
  labs(x = "Patients in the trial", y = "Mean response in the control") +
  theme_bw() +
  theme(legend.position = "none") +
  labs(title = "Control response over time",
       subtitle = paste0("d3 = ", d3))

print(ggarrange(p1, p2, ncol = 1))
```






### Equal time trend

- $\lambda_k = 0.15$, $\forall k$

#### Type I error

```{r, echo=FALSE, fig.height=8}
p <- ggplot(results_ii_eq_alpha %>% filter(lambda1==0.15, d4==800), aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(d3, reject_h0)) +
  geom_point(aes(d3, reject_h0)) +
  labs(x="d3", y="Type I error", color="Analysis approach, arm under study", linetype="") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_ii_eq_alpha$d3), labels = unique(results_ii_eq_alpha$d3)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/ii_eq_alpha.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```

#### Power

```{r, echo=FALSE, fig.height=8}
p <- ggplot(results_ii_eq_pow %>% filter(lambda1==0.15, d4==800), aes(color=model, linetype=as.factor(study_arm))) +
  geom_line(aes(d3, reject_h0)) +
  geom_point(aes(d3, reject_h0)) +
  labs(x="d3", y="Power", color="Analysis approach, arm under study", linetype="") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_ii_eq_pow$d3), labels = unique(results_ii_eq_pow$d3)) +
  theme_bw()

ggplotly(p, dynamicTicks = "y")
#ggsave("figures/ii_eq_pow.png", p + labs(color="Analysis approach", linetype="Arm under study"))
```




## Design III - I

- 10 treatment arms
- Different time trends
- Evaluated treatment arm: 10

Scenario III-I consists of 10 treatment arms, where treatment arm $i$ enters after every $300 \cdot (i-1)$ patients have been recruited to the trial. In this case, only treatment arm 10 is evaluated and has no time trend present, just like the control group ($\lambda_0 = \lambda_{10} = 0$). The time trend in the remaining treatment arms is varied with $\lambda_1=\lambda_2=\ldots=\lambda_9$.

```{r}
trial_data <- datasim_cont(num_arms = 10, 
                           n_arm = 250, 
                           d = c(300*(0:9)),
                           period_blocks = 2,
                           mu0 = 0,
                           sigma = 1,
                           theta = rep(0, 10),
                           lambda = rep(0, 11),
                           trend = "linear")

plot_trial(trial_data$treatment)
```

### Different time trend

#### Type I error - all arms under H0

```{r, echo=FALSE, fig.height=6}
ggplot(results_iii_i_diff_alpha) +
  geom_line(aes(lambda1, reject_h0, color=model)) +
  geom_point(aes(lambda1, reject_h0, color=model)) +
  labs(x="lambda_1", y="Type I error", color="Analysis approach:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_iii_i_diff_alpha$lambda1), labels = unique(results_iii_i_diff_alpha$lambda1)) +
  theme_bw()

#ggsave("figures/iii_i_diff_alpha.png")
```

#### Type I error - arms 1-9 under H1

```{r, echo=FALSE, fig.height=6}
ggplot(results_iii_i_diff_alpha_h1) +
  geom_line(aes(lambda1, reject_h0, color=model)) +
  geom_point(aes(lambda1, reject_h0, color=model)) +
  labs(x="lambda_1", y="Type I error", color="Analysis approach:") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_iii_i_diff_alpha_h1$lambda1), labels = unique(results_iii_i_diff_alpha_h1$lambda1)) +
  theme_bw()

#ggsave("figures/iii_i_diff_alpha_h1.png")
```

#### Power

```{r, echo=FALSE, fig.height=6}
ggplot(results_iii_i_diff_pow) +
  geom_line(aes(lambda1, reject_h0, color=model)) +
  geom_point(aes(lambda1, reject_h0, color=model)) +
  labs(x="lambda_1", y="Power", color="Analysis approach:") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  scale_x_continuous(breaks = unique(results_iii_i_diff_pow$lambda1), labels = unique(results_iii_i_diff_pow$lambda1)) +
  theme_bw()

#ggsave("figures/iii_i_diff_pow.png")
```

## Design III - II

- 10 treatment arms
- Different (random) time trends
- Evaluated treatment arm: 10

Scenario III-II consists of 10 treatment arms, where treatment arm $i$ enters after every $300 \cdot (i-1)$ patients have been recruited to the trial. In this case, only treatment arm 10 is evaluated, while its time trend is varied and is equal to the control group ($\lambda_0 = \lambda_{10}$). The time trend in the remaining treatment arms is sampled from $\lambda_i \sim N(\lambda_0, 0.5), \forall i \in \{1,\ldots,9\}$.


### Different (random) time trend

#### Type I error

```{r, echo=FALSE, fig.height=6}
ggplot(results_iii_ii_rand_alpha) +
  geom_line(aes(lambda0, reject_h0, color=model)) +
  geom_point(aes(lambda0, reject_h0, color=model)) +
  labs(x=TeX("$\\lambda_0 = \\lambda_{10}$"), y="Type I error", color="Analysis approach") +
  geom_hline(aes(yintercept = 0.025), linetype = "dotted") +
  geom_hline(aes(yintercept = pred_int[1]), linetype = "dashed", color = "gray54") +
  geom_hline(aes(yintercept = pred_int[2]), linetype = "dashed", color = "gray54") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  theme_bw()

#ggsave("figures/iii_ii_eq_alpha.png")
```


#### Power

```{r, echo=FALSE, fig.height=6}
ggplot(results_iii_ii_rand_pow) +
  geom_line(aes(lambda0, reject_h0, color=model)) +
  geom_point(aes(lambda0, reject_h0, color=model)) +
  labs(x=TeX("$\\lambda_0 = \\lambda_{10}$"), y="Power", color="Analysis approach") +
  facet_grid(~ trend) +
  scale_color_manual(values = my_palette) +
  theme_bw()

#ggsave("figures/iii_ii_eq_pow.png")
```










